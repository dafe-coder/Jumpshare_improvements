'use strict'

const dataChapters = {
	chapters: [
		{
			M: {
				name: {
					S: 'Foundations of Video Editing',
				},
				line: {
					S: '0',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Organizing Your Workflow',
				},
				line: {
					S: '100',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Utilizing External Drives for Storage',
				},
				line: {
					S: '240',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Choosing the Right Editing Software',
				},
				line: {
					S: '289',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Trimming and Editing Process',
				},
				line: {
					S: '400',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Incorporating B-roll and Stock Footage',
				},
				line: {
					S: '450',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Adding Text and Templates',
				},
				line: {
					S: '600',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Reviewing and Finalizing the Edit',
				},
				line: {
					S: '700',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Rendering and Uploading with Camtasia',
				},
				line: {
					S: '800',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Continuous Improvement in Editing',
				},
				line: {
					S: '1000',
				},
			},
		},
	],
}

const dataComments = {
	comments: [
		{
			id: '2912',
			item_code: 'Dino1qV66wxgBu2jL1ID',
			comment: 'This need to be color too.',
			parent_comment_id: '0',
			replies_count: '4',
			media_timestamp: '20.00859',
			commentator: null,
			date_created: '2024-07-18 06:24:34',
			date_updated: null,
			annotation_json:
				'[{"color":"#F73D72","id":"0","type":"rectangle","x1":"52.44","y1":"58.50","x2":"56.45","y2":"53.98"},{"color":"#F73D72","id":"1","type":"arrow","x1":"62.34","y1":"63.14","x2":"56.39","y2":"53.15"}]',
			latest_reply: {
				id: '2923',
				item_code: 'Dino1qV66wxgBu2jL1ID',
				comment: 'Fifth one',
				media_timestamp: '0',
				parent_comment_id: '2912',
				commentator: null,
				date_created: '2024-07-19 15:51:04',
				date_updated: null,
				user: {
					avatar_hash:
						'<figure class="c-avatar c-avatar--s c-avatar--no-img pull-left" data-original-title="sal kh" data-initials="S" style="border: 1px solid #D12A1E; background-color: #D12A1E"></figure>',
					first_name: 'sal',
					last_name: 'kh',
					email: 'salman@jumpshare.com',
				},
				is_super_owner: true,
				is_owner: true,
				comment_time: 'Jul 19',
			},
			user: {
				avatar_hash:
					'<figure class="c-avatar c-avatar--s c-avatar--no-img pull-left" data-original-title="sal kh" data-initials="S" style="border: 1px solid #D12A1E; background-color: #D12A1E"></figure>',
				first_name: 'sal',
				last_name: 'kh',
				email: 'salman@jumpshare.com',
			},
			is_super_owner: true,
			is_owner: true,
			comment_time: 'Jul 18',
		},
		{
			id: '2917',
			item_code: 'Dino1qV66wxgBu2jL1ID',
			comment: `Very big comment to check the length. I wonder how it will come out. I assume it will look good. But it's worth checking it out. I'm excited to improve this part of the product. Thanks for the output!`,
			parent_comment_id: '0',
			replies_count: '0',
			media_timestamp: '400.5064',
			commentator: null,
			date_created: '2024-07-19 12:04:22',
			date_updated: null,
			annotation_json:
				'[{"color":"#F73D72","id":"0","type":"rectangle","x1":"64.48","y1":"21.52","x2":"73.24","y2":"31.27"}]',
			user: {
				avatar_hash:
					'<figure class="c-avatar c-avatar--s c-avatar--no-img pull-left" data-original-title="sal kh" data-initials="S" style="border: 1px solid #D12A1E; background-color: #D12A1E"></figure>',
				first_name: 'sal',
				last_name: 'kh',
				email: 'salman@jumpshare.com',
			},
			is_super_owner: true,
			is_owner: true,
			comment_time: 'Jul 19',
		},
		{
			id: '2924',
			item_code: 'Dino1qV66wxgBu2jL1ID',
			comment: 'This is first one',
			parent_comment_id: '0',
			replies_count: '4',
			media_timestamp: '800',
			commentator: null,
			date_created: '2024-07-19 15:52:59',
			date_updated: null,
			annotation_json: null,
			latest_reply: {
				id: '2928',
				item_code: 'Dino1qV66wxgBu2jL1ID',
				comment: 'Fifth',
				media_timestamp: '0',
				parent_comment_id: '2924',
				commentator: null,
				date_created: '2024-07-19 15:53:28',
				date_updated: null,
				user: {
					avatar_hash:
						'<figure class="c-avatar c-avatar--s c-avatar--no-img pull-left" data-original-title="sal kh" data-initials="S" style="border: 1px solid #D12A1E; background-color: #D12A1E"></figure>',
					first_name: 'sal',
					last_name: 'kh',
					email: 'salman@jumpshare.com',
				},
				is_super_owner: true,
				is_owner: true,
				comment_time: 'Jul 19',
			},
			user: {
				avatar_hash:
					'<figure class="c-avatar c-avatar--s c-avatar--no-img pull-left" data-original-title="sal kh" data-initials="S" style="border: 1px solid #D12A1E; background-color: #D12A1E"></figure>',
				first_name: 'sal',
				last_name: 'kh',
				email: 'salman@jumpshare.com',
			},
			is_super_owner: true,
			is_owner: true,
			comment_time: 'Jul 19',
		},
	],
}

const dataCTA = {
	status: 1,
	item_code: 'dPPx88gfFBPsxQTyfPfG',
	title: 'Test',
	link: 'http://google.com',
	txt_color: '#FFFFFF',
	btn_color: '#1891ED',
	btn_type: '2',
	cta_type: 'link',
	cta_appearance: '0',
	cta_position: 'top-right',
	show_user_photo: '0',
	show_pulsing_effect: '0',
	cta_from: '0.00',
	avatar_url:
		"<figure class='c-avatar c-avatar--s c-avatar--no-img pull-left' data-original-title='Dmytro Pryvezentsev' data-initials='D' style='border: 1px solid #802476; background-color: #802476'></figure>",
	google_link_final: '',
}

document.addEventListener('DOMContentLoaded', () => {
	// Player elements
	const player = document.getElementById('player')
	const playerWrap = document.querySelector('.player-wrap')
	const playOrPauseBtn = document.getElementById('play-or-pause')
	const muteBtn = document.getElementById('mute')
	const currentTime = document.getElementById('controls-current-time')
	const duration = document.getElementById('controls-duration')
	const playbackRate = document.getElementById('playback-rate')
	const showPlayerOverlayTimer = document.querySelector('.show-player-timer')
	const controls = document.querySelector('.controls')
	const commentsContainer = document.querySelector('.controls-comments')
	const annotationCanvasElement = document.getElementById('annotation_canvas')
	const sliderThumb = document.getElementById('slider-thumb')
	const sliderRail = document.getElementById('controls-time-rail')
	const playerOverlayStart = document.querySelector('.player-overlay-start')

	let controlsShowID = null
	let isCTAButtonGenerated = false
	// Hide native controls
	player.controls = false
	let playerVolumeCount = 0.5

	JSPlayer.Settings.init(player, sliderThumb, playerWrap)
	JSPlayer.Utils.init({
		player,
		playerWrap,
		sliderThumb,
		sliderRail,
		controlsShowID,
		currentTime,
		controls,
		playOrPauseBtn,
		playerVolumeCount,
		dataChapters,
		muteBtn,
	})

	// Player wrap init height
	JSPlayer.Settings.resizeVideoPlayer()

	document.addEventListener('resize', () => {
		JSPlayer.Settings.resizeVideoPlayer()
	})

	// Initialize rough.js

	if (annotationCanvasElement) {
		JSPlayer.Annotation.initialize()
		JSPlayer.Annotation.attach_controls()
		dataComments.comments.forEach(comment => {
			if (comment.annotation_json !== null) {
				JSPlayer.Annotation.attach_annotation_to_dom(
					comment.annotation_json,
					comment.id
				)
			}
		})
	}

	function showAnnotationPanel() {
		showAnnotationBtn.classList.add('active')
		JSPlayer.Helper.toggleSiblingElement(showAnnotationBtn, 'svg')
		document.querySelector('#annotation_panel').classList.add('active')
		JSPlayer.Annotation.initializ_canvas()
		JSPlayer.Annotation.hide_seekbar_and_timed_comments()
	}

	function hideAnnotationPanel() {
		showAnnotationBtn.classList.remove('active')
		JSPlayer.Helper.toggleSiblingElement(showAnnotationBtn, 'svg', true)
		document.querySelector('#annotation_panel').classList.remove('active')
		JSPlayer.Annotation.reset_annotation()
		JSPlayer.Annotation.show_seekbar_and_timed_comments()
	}

	const showAnnotationBtn = document.querySelector('#show-annotation')
	showAnnotationBtn.addEventListener('click', () => {
		if ($('#annotation_canvas').hasClass('pointer-events-none')) {
			$('#annotation_canvas').addClass('hide')
			$('#annotation_canvas').removeClass('pointer-events-none')
		}

		if (!showAnnotationBtn.classList.contains('active')) {
			showAnnotationPanel()
		} else {
			hideAnnotationPanel()
		}
	})

	// HLS init
	const playerSrc = [
		'./20fd0242e93e4fdda762a05a8107cf73/4K-Nature-Film_-_Flow-Of-Life_-30-Minutes-of-Beautiful-Scenery-Relaxing-Music-for-Meditation.m3u8',
		'https://d1ffb1nfch3ckq.cloudfront.net/s095q2%2Ffile%2Fb9b3b32c193e7156d15bdaa2d1929778_f839b6774122ccba2d2b82a1bdc13a48.mp4?response-content-disposition=inline%3Bfilename%3D%22b9b3b32c193e7156d15bdaa2d1929778_f839b6774122ccba2d2b82a1bdc13a48.mp4%22%3B&response-content-type=video%2Fmp4&Expires=1733943645&Signature=EVqiq~KETO974nd288O6-l-soTTJE13EQZ42-mfCpPbJEjxuxdvXoxiBQSc7utUuNCjyXME0E9vx1EzpFyvT2Y78o8xVS46gbo608GAC4NAfUXIJs2jVhnE-N1e~1GhznOlibVO~HNT7poTmIFJilhE7TPrwokhBa9SMv-PRo4SRW9RTbzqK~nLFQaPtffaw8drvwrFeJAM61d52Qf-opuVOKKX5iP4vo9aFF7MXAvpy2J-cbiml658BXZ~LC8KsJ6SYGCdRD-l8cC-9dtnOunkF0tyM7TudLbS4m-B8U1hX4ou2zWQp9-FEofqxy1KAcaPV9YWcS-kIXwli4X-hnA__&Key-Pair-Id=APKAJT5WQLLEOADKLHBQ',
		'../dual_audio_stream/Merged-Track.mp4',
		'../dual_audio_stream/Seperate-Tracks.mp4',
		'https://ocean.mirzabilal.com/iptv/video/prog_index.m3u8',
	]

	let activePlayerSrc = 3
	player.addEventListener('loadedmetadata', () => {
		setTimeout(() => {
			const audioTracks = player.audioTracks
			console.log('Audio tracks after delay:', audioTracks)

			for (let i = 0; i < audioTracks.length; i++) {
				const track = audioTracks[i]
				console.log(`Audio track ${i}:`, track)
				track.enabled = true
			}
		}, 100)
	})

	const audioContext = new (window.AudioContext || window.webkitAudioContext)()

	// const source1 = audioContext.createMediaElementSource(audios)
	// const source2 = audioContext.createMediaElementSource(audios)
	if (
		player.canPlayType('application/vnd.apple.mpegurl') ||
		playerSrc[activePlayerSrc].includes('.mp4')
	) {
		player.src = playerSrc[activePlayerSrc]
	} else if (Hls.isSupported()) {
		var hls = new Hls()
		hls.loadSource(playerSrc[activePlayerSrc])
		hls.attachMedia(player)
	} else {
		console.warn('HLS not supported')
	}

	function handleProgress() {
		const buffered = player.buffered
		const chapterSliderItems = document.querySelectorAll('.chapter-slider-item')
		if (buffered.length > 0 && chapterSliderItems) {
			const loaded = buffered.end(buffered.length - 1)

			chapterSliderItems.forEach(item => {
				const progressItem = item.querySelector('.chapter-slider-loading')
				if (
					item.dataset.dataSliderEndTime >= loaded &&
					item.dataset.dataSliderStartTime <= loaded
				) {
					const total = item.dataset.dataSliderEndTime
					const progress = (loaded / total) * 100
					progressItem.style.width = `${progress}%`
				} else if (item.dataset.dataSliderEndTime <= loaded) {
					progressItem.style.width = '100%'
				}
			})
		}
	}
	player.addEventListener('progress', handleProgress)
	player.addEventListener('loadeddata', handleProgress)

	controls.addEventListener('mousemove', () => {
		JSPlayer.Utils.showHideControls()
		clearTimeout(controlsShowID)
	})
	player.addEventListener('mousemove', e =>
		JSPlayer.Utils.hideShowControlsOnHover(e)
	)
	playerWrap.addEventListener('mouseleave', () => {
		if (!player.paused) {
			JSPlayer.Utils.showHideControls(true)
		}
	})

	playOrPauseBtn.addEventListener('click', e => JSPlayer.Utils.playOrPause(e))
	muteBtn.addEventListener('click', () => JSPlayer.Controls.mute())
	playbackRate.addEventListener('click', () =>
		JSPlayer.Settings.choosePlaybackRate()
	)
	player.addEventListener('click', e => JSPlayer.Utils.playOrPause(e))

	function preparePlayerWhenStartPlaying() {
		commentsContainer.classList.remove('hide')
		// Generate CTA button
		if (!isCTAButtonGenerated) {
			JSPlayer.CTA.generateCTAButton(dataCTA)
			isCTAButtonGenerated = true
		}
		playerOverlayStart.style.display = 'none'
		document
			.querySelector('.player-wrap')
			.classList.add('player-overlay-played')
		JSPlayer.Helper.toggleSiblingElement(playOrPauseBtn, 'svg')
		JSPlayer.Utils.showHideControls()
		player.play()
	}

	JSPlayer.Settings.hideTextTracks()
	player.addEventListener('loadedmetadata', () => {
		setTimeout(() => {
			JSPlayer.Settings.hideTextTracks()
		}, 10)
		JSPlayer.Settings.applyPlayerColorTheme({ primary: '#1891ED' })
		duration.innerText = JSPlayer.Helper.formatTime(player.duration)
		showPlayerOverlayTimer.style.display = 'block'
		showPlayerOverlayTimer.querySelector('span').innerText =
			JSPlayer.Helper.formatTime(player.duration, true)
		player.volume = playerVolumeCount

		// Load comments

		JSPlayer.Comments.init(player, commentsContainer, dataChapters)
		JSPlayer.Comments.load(dataComments)

		// overlay player start

		playerOverlayStart.addEventListener('click', preparePlayerWhenStartPlaying)

		JSPlayer.Chapters.init(player)
		JSPlayer.Chapters.load(dataChapters)
		JSPlayer.Comments.add(
			{
				seconds: JSPlayer.Helper.parseToSeconds('17:26'),
				comment: ' Added a comment using the "addComment" method',
			},
			dataComments
		)
	})

	const commentNewTextareaWrapper = document.querySelector(
		'.comment-new-textarea-wrapper'
	)
	const addCommentBtn = document.querySelector('#add-comment')
	const commentText = document.querySelector('#comment-text')
	commentNewTextareaWrapper.addEventListener('click', () => {
		player.pause()
	})

	addCommentBtn.addEventListener('click', () => {
		if (commentText.value !== '') {
			const id = Number(new Date().getTime() * Math.random())
			const shapes =
				JSPlayer.Annotation.shapes.length > 0
					? JSON.stringify(JSPlayer.Annotation.shapes)
					: null

			const oldAnnotation = []

			hideAnnotationPanel()

			if (shapes) {
				dataComments.comments.forEach(comment => {
					if (comment.annotation_json !== null) {
						oldAnnotation.push({
							annotation: comment.annotation_json,
							id: comment.id,
						})
					}
				})
				oldAnnotation.push({
					annotation: shapes,
					id: id,
				})
			}

			JSPlayer.Comments.add(
				{
					id: id,
					seconds: player.currentTime,
					comment: commentText.value,
					shapes,
				},
				dataComments
			)

			if (shapes) {
				oldAnnotation.forEach(item => {
					JSPlayer.Annotation.attach_annotation_to_dom(item.annotation, item.id)
				})
			}
			commentText.value = ''
		}
	})

	// Slider player (time rail)
	const controlsTimeRail = document.getElementById('controls-time-rail')

	let isDragging = false
	let isDraggingType = 'time'

	controlsTimeRail.addEventListener('mousedown', event => {
		isDragging = true
		isDraggingType = 'time'
		JSPlayer.Utils.moveSlider(event, controlsTimeRail, isDraggingType)
	})

	player.addEventListener('timeupdate', () => {
		currentTime.innerText = JSPlayer.Helper.formatTime(player.currentTime)
		JSPlayer.Comments.checkIsCommentActive(player.currentTime)
		JSPlayer.Utils.updateSlider(dataChapters)
		JSPlayer.Chapters.updateActiveChapterTitle(dataChapters)
	})

	// Volume slider

	const volumeSlider = document.getElementById('volume-slider')

	volumeSlider.addEventListener('mousedown', event => {
		isDragging = true
		isDraggingType = 'volume'
		JSPlayer.Utils.moveSlider(event, volumeSlider, isDraggingType)
	})

	window.addEventListener('mousemove', event => {
		if (isDragging && isDraggingType === 'time') {
			JSPlayer.Utils.moveSlider(event, controlsTimeRail, isDraggingType)
		} else if (isDragging && isDraggingType === 'volume') {
			JSPlayer.Utils.moveSlider(event, volumeSlider, isDraggingType)
		}
	})
	window.addEventListener('mouseup', () => {
		isDragging = false
	})

	// When the video ends
	const playerOverlayEnd = document.querySelector('.player-overlay-end')
	const playerOverlayBtnEnd = document.querySelector(
		'.player-overlay-button-end'
	)

	player.addEventListener('ended', () => {
		const playerCtaButtonDefault = document.querySelector(
			'.player-cta-button-default'
		)
		JSPlayer.Utils.showHideControls(true)
		commentsContainer.style.display = 'none'
		playerOverlayEnd.style.display = 'flex'
		playerCtaButtonDefault.classList.add('hidden')
		JSPlayer.Helper.toggleSiblingElement(playOrPauseBtn, 'svg', true)
		JSPlayer.Chapters.activeChapter = 1
	})

	playerOverlayBtnEnd.addEventListener('click', () => {
		const playerCtaButtonDefault = document.querySelector(
			'.player-cta-button-default'
		)
		commentsContainer.style.display = 'block'
		player.currentTime = 0
		player.play()
		playerOverlayEnd.style.display = 'none'
		playerCtaButtonDefault.classList.remove('hidden')
		JSPlayer.Helper.toggleSiblingElement(playOrPauseBtn, 'svg')
	})

	// Controls
	JSPlayer.Controls.init(player, playerWrap, playerVolumeCount)

	// Theatre mode
	const theatreBtn = document.getElementById('theatre-mode')
	theatreBtn.addEventListener('click', () => JSPlayer.Controls.theatreMode())
	// Fullscreen
	const fullScreenBtn = document.getElementById('fullscreen')

	fullScreenBtn.addEventListener('click', () =>
		JSPlayer.Controls.toggleFullScreen()
	)

	document.addEventListener(
		'fullscreenchange',
		JSPlayer.Controls.toggleFullscreenStyles
	)
	document.addEventListener(
		'webkitfullscreenchange',
		JSPlayer.Controls.toggleFullscreenStyles
	)
	document.addEventListener(
		'mozfullscreenchange',
		JSPlayer.Controls.toggleFullscreenStyles
	)

	// Keyboard
	document.addEventListener('keydown', e => {
		const skipAmount = 10
		const isTyping = ['INPUT', 'TEXTAREA'].includes(
			document.activeElement.tagName
		)

		if (player.currentTime > 0 && !isTyping) {
			if (e.code === 'Space') {
				e.preventDefault()
				if (player.paused || player.ended) {
					preparePlayerWhenStartPlaying()
					player.play()
					JSPlayer.Helper.toggleSiblingElement(playOrPauseBtn, 'svg')
				} else {
					player.pause()
					JSPlayer.Helper.toggleSiblingElement(playOrPauseBtn, 'svg', true)
				}
			}
			if (e.code === 'ArrowLeft') {
				player.currentTime -= skipAmount
				JSPlayer.Chapters.chooseActiveChapter()
				JSPlayer.Utils.updateSlider(dataChapters)
			}
			if (e.code === 'ArrowRight') {
				player.currentTime += skipAmount
				JSPlayer.Chapters.chooseActiveChapter()
				JSPlayer.Utils.updateSlider(dataChapters)
			}
			if (e.code === 'KeyK') {
				toggleFullScreen()
			}
		}
	})

	//  On loading
	const loadingBgSpinner = document.querySelector('.loading-bg-img')
	player.addEventListener('waiting', () => {
		loadingBgSpinner.style.display = 'block'
	})
	player.addEventListener('canplay', () => {
		loadingBgSpinner.style.display = 'none'
	})
	player.addEventListener('playing', () => {
		loadingBgSpinner.style.display = 'none'
	})

	// Captions
	const captionTrack = document.getElementById('captions-track')
	const captionBtn = document.getElementById('captions-btn')
	const customCaptions = document.querySelector('.custom-captions')
	let isShowCaptions = false
	let activeCuesLength = 0
	customCaptions.style.display = 'none'

	JSPlayer.Captions.init(customCaptions)

	captionBtn.addEventListener('click', () => {
		if (isShowCaptions) {
			isShowCaptions = false
			customCaptions.style.display = 'none'
			JSPlayer.Helper.toggleSiblingElement(captionBtn, 'svg', true)
		} else {
			if (activeCuesLength > 0) {
				customCaptions.style.display = 'block'
			} else {
				customCaptions.style.display = 'none'
			}
			isShowCaptions = true
			JSPlayer.Helper.toggleSiblingElement(captionBtn, 'svg')
		}
	})

	captionTrack.addEventListener('cuechange', () => {
		const activeCues = player.textTracks[0].activeCues

		activeCuesLength = activeCues.length

		if (isShowCaptions && activeCues.length > 0) {
			JSPlayer.Captions.showCaptions(activeCues[0].text)
		} else {
			JSPlayer.Captions.hideCaptions(
				activeCues.length > 0 && activeCues[0].text
			)
		}
	})

	// Generate Ð¡TA Button
	JSPlayer.CTA.init(playerWrap, playerOverlayEnd)

	// Errors
	player.addEventListener('error', e => {
		const error = e.error
		switch (error.code) {
			case 1: // MEDIA_ERR_ABORTED
				console.log('Download interrupted')
				break
			case 2: // MEDIA_ERR_NETWORK
				console.log('Network error')
				break
			case 3: // MEDIA_ERR_DECODE
				console.log('Decoding error')
				break
			case 4: // MEDIA_ERR_SRC_NOT_SUPPORTED
				console.log('Format not supported')
				break
			default:
				console.log('Unknown error')
		}
		console.log('Error details:', error.message)
	})

	// ARIA attributes for control buttons
	playOrPauseBtn.setAttribute('aria-label', 'Play/Pause')
	muteBtn.setAttribute('aria-label', 'Mute')
	fullScreenBtn.setAttribute('aria-label', 'Fullscreen')
})
