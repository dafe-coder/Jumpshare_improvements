'use strict'
const dataChapters = {
	chapters: [
		{
			M: {
				name: {
					S: 'Foundations of Video Editing',
				},
				line: {
					S: '0',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Organizing Your Workflow',
				},
				line: {
					S: '100',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Utilizing External Drives for Storage',
				},
				line: {
					S: '240',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Choosing the Right Editing Software',
				},
				line: {
					S: '289',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Trimming and Editing Process',
				},
				line: {
					S: '400',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Incorporating B-roll and Stock Footage',
				},
				line: {
					S: '450',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Adding Text and Templates',
				},
				line: {
					S: '600',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Reviewing and Finalizing the Edit',
				},
				line: {
					S: '700',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Rendering and Uploading with Camtasia',
				},
				line: {
					S: '800',
				},
			},
		},
		{
			M: {
				name: {
					S: 'Continuous Improvement in Editing',
				},
				line: {
					S: '1000',
				},
			},
		},
	],
}

const dataComments = {
	comments: [
		{
			id: '2912',
			item_code: 'Dino1qV66wxgBu2jL1ID',
			comment: 'This need to be color too.',
			parent_comment_id: '0',
			replies_count: '4',
			media_timestamp: '20.00859',
			commentator: null,
			date_created: '2024-07-18 06:24:34',
			date_updated: null,
			annotation_json:
				'[{"color":"#F73D72","id":"0","type":"rectangle","x1":"52.44","y1":"58.50","x2":"56.45","y2":"53.98"},{"color":"#F73D72","id":"1","type":"arrow","x1":"62.34","y1":"63.14","x2":"56.39","y2":"53.15"}]',
			latest_reply: {
				id: '2923',
				item_code: 'Dino1qV66wxgBu2jL1ID',
				comment: 'Fifth one',
				media_timestamp: '0',
				parent_comment_id: '2912',
				commentator: null,
				date_created: '2024-07-19 15:51:04',
				date_updated: null,
				user: {
					avatar_hash:
						'<figure class="c-avatar c-avatar--s c-avatar--no-img pull-left" data-original-title="sal kh" data-initials="S" style="border: 1px solid #D12A1E; background-color: #D12A1E"></figure>',
					first_name: 'sal',
					last_name: 'kh',
					email: 'salman@jumpshare.com',
				},
				is_super_owner: true,
				is_owner: true,
				comment_time: 'Jul 19',
			},
			user: {
				avatar_hash:
					'<figure class="c-avatar c-avatar--s c-avatar--no-img pull-left" data-original-title="sal kh" data-initials="S" style="border: 1px solid #D12A1E; background-color: #D12A1E"></figure>',
				first_name: 'sal',
				last_name: 'kh',
				email: 'salman@jumpshare.com',
			},
			is_super_owner: true,
			is_owner: true,
			comment_time: 'Jul 18',
		},
		{
			id: '2917',
			item_code: 'Dino1qV66wxgBu2jL1ID',
			comment: `Very big comment to check the length. I wonder how it will come out. I assume it will look good. But it's worth checking it out. I'm excited to improve this part of the product. Thanks for the output!`,
			parent_comment_id: '0',
			replies_count: '0',
			media_timestamp: '400.5064',
			commentator: null,
			date_created: '2024-07-19 12:04:22',
			date_updated: null,
			annotation_json:
				'[{"color":"#F73D72","id":"0","type":"rectangle","x1":"64.48","y1":"21.52","x2":"73.24","y2":"31.27"}]',
			user: {
				avatar_hash:
					'<figure class="c-avatar c-avatar--s c-avatar--no-img pull-left" data-original-title="sal kh" data-initials="S" style="border: 1px solid #D12A1E; background-color: #D12A1E"></figure>',
				first_name: 'sal',
				last_name: 'kh',
				email: 'salman@jumpshare.com',
			},
			is_super_owner: true,
			is_owner: true,
			comment_time: 'Jul 19',
		},
		{
			id: '2924',
			item_code: 'Dino1qV66wxgBu2jL1ID',
			comment: 'This is first one',
			parent_comment_id: '0',
			replies_count: '4',
			media_timestamp: '800',
			commentator: null,
			date_created: '2024-07-19 15:52:59',
			date_updated: null,
			annotation_json: null,
			latest_reply: {
				id: '2928',
				item_code: 'Dino1qV66wxgBu2jL1ID',
				comment: 'Fifth',
				media_timestamp: '0',
				parent_comment_id: '2924',
				commentator: null,
				date_created: '2024-07-19 15:53:28',
				date_updated: null,
				user: {
					avatar_hash:
						'<figure class="c-avatar c-avatar--s c-avatar--no-img pull-left" data-original-title="sal kh" data-initials="S" style="border: 1px solid #D12A1E; background-color: #D12A1E"></figure>',
					first_name: 'sal',
					last_name: 'kh',
					email: 'salman@jumpshare.com',
				},
				is_super_owner: true,
				is_owner: true,
				comment_time: 'Jul 19',
			},
			user: {
				avatar_hash:
					'<figure class="c-avatar c-avatar--s c-avatar--no-img pull-left" data-original-title="sal kh" data-initials="S" style="border: 1px solid #D12A1E; background-color: #D12A1E"></figure>',
				first_name: 'sal',
				last_name: 'kh',
				email: 'salman@jumpshare.com',
			},
			is_super_owner: true,
			is_owner: true,
			comment_time: 'Jul 19',
		},
	],
}

const dataCTA = {
	status: 1,
	item_code: 'dPPx88gfFBPsxQTyfPfG',
	title: 'Test',
	link: 'http://google.com',
	txt_color: '#FFFFFF',
	btn_color: '#1891ED',
	btn_type: '2',
	cta_type: 'link',
	cta_appearance: '0',
	cta_position: 'top-right',
	show_user_photo: '0',
	show_pulsing_effect: '0',
	cta_from: '0.00',
	avatar_url:
		"<figure class='c-avatar c-avatar--s c-avatar--no-img pull-left' data-original-title='Dmytro Pryvezentsev' data-initials='D' style='border: 1px solid #802476; background-color: #802476'></figure>",
	google_link_final: '',
}

document.addEventListener('DOMContentLoaded', () => {
	const playerSettings = {
		themeColor: {
			primary: '#1891ED',
			secondary: 'rgba(255, 255, 255, 0.5)',
		},
		videoSize: '640x360',
		comments: {
			addComment,
			deleteComment,
			loadComments,
		},
		chapters: {
			loadChapters,
		},
		annotation: {
			annotation_json:
				'[{"color":"#F73D72","id":"0","type":"rectangle","x1":"49.19","y1":"20.98","x2":"82.96","y2":"77.73"}]',
		},
	}

	// Player elements
	const player = document.getElementById('player')
	const playerWrap = document.querySelector('.player-wrap')
	const playOrPauseBtn = document.getElementById('play-or-pause')
	const muteBtn = document.getElementById('mute')
	const currentTime = document.getElementById('controls-current-time')
	const duration = document.getElementById('controls-duration')
	const playbackRate = document.getElementById('playback-rate')
	const showPlayerOverlayTimer = document.querySelector('.show-player-timer')
	const controls = document.querySelector('.controls')
	const commentsContainer = document.querySelector('.controls-comments')
	const annotationCanvasElement = document.getElementById('annotation_canvas')
	let controlsShowID = null
	// Hide native controls
	player.controls = false
	let playerVolumeCount = 0.5

	// Player wrap init height
	function resizeVideoPlayer() {
		const playerHeight = playerSettings.videoSize.split('x')[1]
		const playerWidth = playerSettings.videoSize.split('x')[0]
		playerWrap.style.height =
			(playerHeight / playerWidth) * playerWrap.getBoundingClientRect().width +
			'px'
	}

	document.addEventListener('resize', () => {
		resizeVideoPlayer()
	})

	// Initialize rough.js
	let isDeleteMode = false
	playerSettings.annotation = {
		handle_annotation_id: '#show-annotation',
		annotation_panel_id: '#annotation_panel',
		annotation_canvas_id: '#annotation_canvas',
		offsetX: 0,
		offsetY: 0,
		resizeDir: null,
		rect_count: 0,
		initialWindowWidth: 0,
		initialWindowHeight: 0,
		ctx: null,
		roughCanvas: null,
		generator: null,
		isDrawing: false,
		action: null,
		currentTool: 'rectangle',
		currentColor: '#F73D72',
		shapes: [],
		previous_annotation: [],
		annotation_has_started: false,
		editMode: false,
		event_added: false,
		in_annotation_mode: false,

		initialize: function () {
			this.bootstrap()
			this.attachWindowResizeListener()
		},

		bootstrap: function () {
			this.bootstrap_dom()
		},

		bootstrap_dom: function () {
			this.handle_annotation = $(this.handle_annotation_id)
			this.annotation_panel = $(this.annotation_panel_id)
			this.annotation_canvas = $(this.annotation_canvas_id)
			this.add_annotation_panel()
			this.initialWindowWidth = $('#video_wrapper').width()
			this.initialWindowHeight = $('#video_wrapper').height()
			// window.addEventListener('resize', this.attachWindowResizeListener, false);
		},

		px_to_percentage_vertical: function (px, initialWindowHeight) {
			return (px / initialWindowHeight) * 100
		},
		percentage_to_px_vertical: function (percentage, initialWindowHeight) {
			return (percentage * initialWindowHeight) / 100
		},
		px_to_percentage_horizontal: function (px, initialWindowWidth) {
			return (px / initialWindowWidth) * 100
		},
		percentage_to_px_horizontal: function (percentage, initialWindowWidth) {
			return (parseFloat(percentage).toFixed(2) * initialWindowWidth) / 100
		},

		add_annotation_panel: function () {
			this.handle_annotation.unbind().bind('click', () => {
				playerSettings.annotation.first_time_clicked = true
				if (!$('#annotation_canvas').hasClass('hide')) {
					this.handle_annotation.removeClass('ann_active')
					$('#annotation_canvas').addClass('hide')
					this.ctx &&
						this.ctx.clearRect(
							0,
							0,
							this.annotation_canvas[0].width,
							this.annotation_canvas[0].height
						)
					this.currentColor = '#F73D72'
					this.currentTool = 'rectangle'
					// $('#annotation_panel').remove()
					this.shapes = []
					playerSettings.annotation.shapes.splice(
						0,
						playerSettings.annotation.shapes.length
					)
				} else {
					this.handle_annotation.addClass('ann_active')
					$('#annotation_canvas').removeClass('hide')
					this.attach_annotation_panel()
					// $('#comments_activity').slideDown(100)
					// $('#show-annotation').css('bottom', '7px')
					// $('#comment_person_icon').css('bottom', '14px')

					setTimeout(function () {
						player.pause()
					}, 10)
				}

				if (!player.startedPlaying) {
					$('.player-overlay-start').addClass('hide')
				}
			})
		},

		hide_seekbar_and_timed_comments: function () {
			player.pause()
			$('.controls').removeClass('active')
			$('.player-cta-button').addClass('hide')
			$('#custom_captions_wrapper').addClass('hide')
			$('.controls-comments').addClass('hide')
			// $('#time_stmp_coments_wrpr').addClass('stick_to_bottom')
		},

		show_seekbar_and_timed_comments: function () {
			player.pause()
			$('.controls').addClass('active')
			$('.player-cta-button').removeClass('hide')
			$('#custom_captions_wrapper').removeClass('hide')
			$('.controls-comments').removeClass('hide')
			// $('#time_stmp_coments_wrpr').addClass('stick_to_bottom')
		},

		attach_annotation_to_dom: function (annotation_arr, id) {
			this.initializ_canvas()

			let _annotation_arr = JSON.parse(annotation_arr).map(item => {
				if (item.type === 'freehand') {
					return {
						color: item.color,
						type: item.type,
						id: parseFloat(item.id).toFixed(2),
						x1: parseFloat(item.x1).toFixed(2),
						x2: parseFloat(item.x2).toFixed(2),
						y1: parseFloat(item.y1).toFixed(2),
						y2: parseFloat(item.y2).toFixed(2),
						points: item.points.map(point => ({
							x2: parseFloat(point.x2).toFixed(2),
							y2: parseFloat(point.y2).toFixed(2),
						})),
					}
				} else {
					return this.create_new_element(
						parseFloat(item.id).toFixed(2),
						parseFloat(item.x1).toFixed(2),
						parseFloat(item.y1).toFixed(2),
						parseFloat(item.x2).toFixed(2),
						parseFloat(item.y2).toFixed(2),
						item.type,
						item.color
					)
				}
			})

			this.previous_annotation.push({
				comment_id: id,
				annotation: _annotation_arr,
			})
		},

		get_distance: function (a, b) {
			return Math.sqrt(Math.pow(a.x - b.x, 2) + Math.pow(a.y - b.y, 2))
		},

		create_new_element: function (id, x1, y1, x2, y2, type, color) {
			let roughElement

			let _x1 = this.percentage_to_px_horizontal(
				x1,
				$('#video_wrapper').width()
			)
			let _y1 = this.percentage_to_px_vertical(y1, $('#video_wrapper').height())
			let _x2 = this.percentage_to_px_horizontal(
				x2,
				$('#video_wrapper').width()
			)
			let _y2 = this.percentage_to_px_vertical(y2, $('#video_wrapper').height())
			let arrowDawan = false
			if (this.annotation_canvas[0]) {
				if (type === 'line') {
					roughElement = this.generator.line(_x1, _y1, _x2, _y2, {
						roughness: 0,
						stroke: color,
						strokeWidth: 4,
					})
					return { id, x1, y1, x2, y2, type, roughElement, color }
				} else if (type === 'rectangle') {
					roughElement = this.generator.rectangle(
						_x1,
						_y1,
						_x2 - _x1,
						_y2 - _y1,
						{ roughness: 0, stroke: color, strokeWidth: 4 }
					)
					return { id, x1, y1, x2, y2, type, roughElement, color }
				} else if (type === 'arrow') {
					const angle = Math.atan2(_y2 - _y1, _x2 - _x1)
					const headLength = 10
					roughElement = `M ${_x1} ${_y1} L ${_x2} ${_y2}`

					roughElement += `M ${_x2} ${_y2} L ${_x2 - headLength * Math.cos(angle - Math.PI / 6)} ${_y2 - headLength * Math.sin(angle - Math.PI / 6)}`
					roughElement += `M ${_x2} ${_y2} L ${_x2 - headLength * Math.cos(angle + Math.PI / 6)} ${_y2 - headLength * Math.sin(angle + Math.PI / 6)}`

					return { id, x1, y1, x2, y2, type, roughElement, color }
				} else if (type === 'freehand') {
					return {
						id,
						type,
						_x1,
						_y1,
						_x2,
						_y2,
						points: [{ x: x1, y: y1 }],
						color,
					}
				}
			}
		},

		is_on_the_line: function (x1, y1, x2, y2, x, y, maxDistance = 1) {
			const a = { x: x1, y: y1 }
			const b = { x: x2, y: y2 }
			const c = { x, y }
			const offset =
				playerSettings.annotation.get_distance(a, b) -
				(playerSettings.annotation.get_distance(a, c) +
					playerSettings.annotation.get_distance(b, c))
			return Math.abs(offset) < maxDistance ? 'inside' : null
		},

		is_with_element: function (x, y, element) {
			const { type, x1, x2, y1, y2 } = element
			if (type === 'rectangle') {
				const minX = Math.min(x1, x2)
				const maxX = Math.max(x1, x2)
				const minY = Math.min(y1, y2)
				const maxY = Math.max(y1, y2)
				return x >= minX && x <= maxX && y >= minY && y <= maxY
			} else if (type === 'line') {
				const a = { x: x1, y: y1 }
				const b = { x: x2, y: y2 }
				const c = { x, y }
				const offset =
					playerSettings.annotation.get_distance(a, b) -
					(playerSettings.annotation.get_distance(a, c) +
						playerSettings.annotation.get_distance(b, c))
				return Math.abs(offset) < 1
			} else if (type === 'arrow') {
				const a = { x: x1, y: y1 }
				const b = { x: x2, y: y2 }
				const c = { x, y }
				const offset =
					playerSettings.annotation.get_distance(a, b) -
					(playerSettings.annotation.get_distance(a, c) +
						playerSettings.annotation.get_distance(b, c))
				return Math.abs(offset) < 1
			} else if (type === 'freehand') {
				const betweenAnyPoint = element.points.some((point, index) => {
					const nextPoint = element.points[index + 1]
					if (!nextPoint) return false
					return (
						playerSettings.annotation.is_on_the_line(
							point.x2,
							point.y2,
							nextPoint.x2,
							nextPoint.y2,
							x,
							y,
							5
						) != null
					)
				})
				return betweenAnyPoint ? 'inside' : null
			}
		},

		updatedElement: function (id, x1, y1, x2, y2, type, color) {
			if (type === 'freehand') {
				// const _updatedElement = playerSettings.annotation.create_new_element(id, x1, y1, x2, y2, type, color);
				this.shapes[id].points = [...this.shapes[id].points, { x2, y2 }]
				this.render()
			} else {
				const _updatedElement = playerSettings.annotation.create_new_element(
					id,
					x1,
					y1,
					x2,
					y2,
					type,
					color
				)
				this.shapes[id] = _updatedElement
				this.render()
			}
		},

		initializ_canvas: function () {
			console.log('initializ_canvas')
			this.annotation_has_started = true

			if (this.annotation_canvas[0]) {
				this.ctx = this.annotation_canvas[0].getContext('2d')
				this.roughCanvas = rough.canvas(this.annotation_canvas[0])
				this.generator = this.roughCanvas.generator
				this.annotation_canvas[0].width = $('#video_wrapper').width()
				this.annotation_canvas[0].height = $('#video_wrapper').height()

				this.ctx.lineWidth = 2
				this.ctx.strokeStyle = this.currentColor
				this.ctx.lineJoin = 'round'
				this.ctx.lineCap = 'round'
			}
		},

		attach_drawing_controls: function (comment_id) {
			// $('#annotation_panel').remove()
			const template = `<div class="annotation_panel" id="annotation_panel">
									<div id="darwing_shapes_wrapper">
										<span id="delete_shape"><svg width="14" height="16" viewBox="0 0 14 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 4.25H13" stroke="#8F989C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M5.5 7.25V11.75" stroke="#8F989C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.5 7.25V11.75" stroke="#8F989C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M1.75 4.25L2.5 13.25C2.5 13.6478 2.65804 14.0294 2.93934 14.3107C3.22064 14.592 3.60218 14.75 4 14.75H10C10.3978 14.75 10.7794 14.592 11.0607 14.3107C11.342 14.0294 11.5 13.6478 11.5 13.25L12.25 4.25" stroke="#8F989C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M4.75 4.25V2C4.75 1.80109 4.82902 1.61032 4.96967 1.46967C5.11032 1.32902 5.30109 1.25 5.5 1.25H8.5C8.69891 1.25 8.88968 1.32902 9.03033 1.46967C9.17098 1.61032 9.25 1.80109 9.25 2V4.25" stroke="#8F989C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
										<span id="arrow_shape"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.12624 6.86474C3.01417 6.59497 2.62185 6.6282 2.55674 6.91296L0.726584 14.9175C0.677287 15.1331 0.870297 15.3261 1.0859 15.2768L9.09043 13.4467C9.3752 13.3815 9.40842 12.9892 9.13865 12.8772L6.71887 11.8719L15.7794 0.505069C15.9279 0.318761 15.6846 0.0755057 15.4983 0.224012L4.13151 9.28452L3.12624 6.86474Z" fill="#8F989C"/></svg></span>
										<span id="pencil_shape"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.6038 2.08579L13.6038 5.08579L14.8967 3.79289C15.2872 3.40237 15.2872 2.7692 14.8967 2.37868L13.3109 0.792893C12.9204 0.402369 12.2872 0.402369 11.8967 0.792893L10.6038 2.08579ZM9.75022 2.93934L1.60377 11.0858L0.037062 15.0026C-0.1262 15.4107 0.278839 15.8158 0.686996 15.6525L4.60377 14.0858L12.7502 5.93934C12.9455 5.74408 12.9455 5.4275 12.7502 5.23223L10.4573 2.93934C10.2621 2.74408 9.94548 2.74408 9.75022 2.93934Z" fill="#8F989C"/></svg></span>
										<span id="line_shape"><svg width="15" height="16" viewBox="0 0 15 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 13.5L13 2.5" stroke="#8F989C" stroke-width="4" stroke-linecap="round"/></svg></span>
										<span id="rect_shape" class="active"><svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg"><mask id="path-1-inside-1_4310_254" fill="white"><rect y="0.5" width="16" height="16" rx="2"/></mask><rect y="0.5" width="16" height="16" rx="2" stroke="#72797C" stroke-width="4.4" mask="url(#path-1-inside-1_4310_254)"/></svg></span>
									</div>
									<div id="darwing_colors_wrapper">
										<span id="yellow_ann" class="annotation_color yellow"></span>
										<span id="red_ann" class="annotation_color red active"></span>
										<span id="blue_ann" class="annotation_color blue"></span>
										<span id="orange_ann" class="annotation_color orange"></span>
										<span id="green_ann" class="annotation_color green"></span>
									</div>
								</div>`
			if (!comment_id) {
				$('#comment_new').after(template)
			} else {
				$(`#comment_card_${comment_id}`).after(template)
			}
			this.attach_controls()
		},

		attach_annotation_panel: function () {
			$('#annotation_canvas').addClass('darwingMode')
			// this.attach_drawing_controls()
			if (!this.event_added) {
				this.initializ_canvas()
				this.attach_event_listeners_to_canvas()
			}
		},
		attach_event_listeners_to_canvas: function () {
			this.event_added = true
			const getElementAtPosition = (x, y, shapes) => {
				return shapes.find(element => this.is_with_element(x, y, element))
			}
			$('#annotation_canvas')
				.off('mousedown')
				.on('mousedown', e => {
					e.stopPropagation()
					this.hide_seekbar_and_timed_comments()
					this.in_annotation_mode = true
					const { offsetX, offsetY } = e
					if (this.action === 'delete') {
						let _offsetX = this.px_to_percentage_horizontal(
							offsetX,
							$('#video_wrapper').width()
						)
						let _offsetY = this.px_to_percentage_vertical(
							offsetY,
							$('#video_wrapper').height()
						)

						const element = getElementAtPosition(
							_offsetX,
							_offsetY,
							this.shapes
						)
						if (element) {
							this.shapes = this.shapes.filter(item => item.id !== element.id)
							this.render()
						}
					} else {
						this.action = 'drawing'
						this.isDrawing = true
						let id = this.shapes.length

						let _offsetX = this.px_to_percentage_horizontal(
							offsetX,
							$('#video_wrapper').width()
						)
						let _offsetY = this.px_to_percentage_vertical(
							offsetY,
							$('#video_wrapper').height()
						)

						const element = playerSettings.annotation.create_new_element(
							id,
							_offsetX,
							_offsetY,
							_offsetX,
							_offsetY,
							this.currentTool,
							this.currentColor
						)
						this.shapes.push(element)
					}
				})

			$('#annotation_canvas')
				.off('mousemove')
				.on('mousemove', e => {
					e.stopPropagation()
					const { offsetX, offsetY } = e

					const updated_offsetX =
						offsetX *
						(this.annotation_canvas[0].width /
							this.annotation_canvas[0].clientWidth)
					const updated_offsetY =
						offsetY *
						(this.annotation_canvas[0].height /
							this.annotation_canvas[0].clientHeight)
					let _offsetX = this.px_to_percentage_horizontal(
						updated_offsetX,
						$('#video_wrapper').width()
					)
					let _offsetY = this.px_to_percentage_vertical(
						updated_offsetY,
						$('#video_wrapper').height()
					)

					if (this.currentTool === 'delete') {
						// let _offsetX = this.px_to_percentage_horizontal(offsetX, $("#video_wrapper").width());
						// let _offsetY = this.px_to_percentage_vertical(offsetY, $("#video_wrapper").height());

						const element = getElementAtPosition(
							_offsetX,
							_offsetY,
							this.shapes
						)
						if (element) {
							$('#annotation_canvas').addClass('delete_mode')
						} else {
							$('#annotation_canvas').removeClass('delete_mode')
						}
					}
					if (!this.isDrawing) {
						return
					}
					if (this.action === 'drawing') {
						const index = this.shapes.length - 1
						const { x1, y1 } = this.shapes[index]

						// let _offsetX = this.px_to_percentage_horizontal(offsetX, $("#video_wrapper").width());
						// let _offsetY = this.px_to_percentage_vertical(offsetY, $("#video_wrapper").height());

						this.updatedElement(
							index,
							x1,
							y1,
							_offsetX,
							_offsetY,
							this.currentTool,
							this.currentColor
						)
					}
				})

			$('#annotation_canvas').on('mouseup', e => {
				e.stopPropagation()
				this.isDrawing = false
			})
		},

		attach_controls: function () {
			$('#rect_shape')
				.unbind()
				.bind('click', () => {
					console.log('arrow_shape')

					$('#darwing_shapes_wrapper span').removeClass('active')
					$('#rect_shape').addClass('active')
					this.currentTool = 'rectangle'
					this.action = 'drawing'
				})

			$('#arrow_shape')
				.unbind()
				.bind('click', () => {
					$('#darwing_shapes_wrapper span').removeClass('active')
					$('#arrow_shape').addClass('active')
					this.currentTool = 'arrow'
					this.action = 'drawing'
				})

			$('#line_shape')
				.unbind()
				.bind('click', () => {
					$('#darwing_shapes_wrapper span').removeClass('active')
					$('#line_shape').addClass('active')
					this.currentTool = 'line'
					this.action = 'drawing'
				})

			$('#pencil_shape')
				.unbind()
				.bind('click', () => {
					$('#darwing_shapes_wrapper span').removeClass('active')
					$('#pencil_shape').addClass('active')
					this.currentTool = 'freehand'
					this.action = 'drawing'
				})

			$('#delete_shape')
				.unbind()
				.bind('click', () => {
					$('#darwing_shapes_wrapper span').removeClass('active')
					$('#delete_shape').addClass('active')
					this.currentTool = 'delete'
					isDeleteMode = false
					this.action = 'delete'
				})

			$('#green_ann')
				.unbind()
				.bind('click', () => {
					$('#darwing_colors_wrapper span').removeClass('active')
					$('#green_ann').addClass('active')
					this.currentColor = '#34E33B'
				})

			$('#blue_ann')
				.unbind()
				.bind('click', () => {
					$('#darwing_colors_wrapper span').removeClass('active')
					$('#blue_ann').addClass('active')
					this.currentColor = '#3696F6'
				})

			$('#red_ann')
				.unbind()
				.bind('click', () => {
					$('#darwing_colors_wrapper span').removeClass('active')
					$('#red_ann').addClass('active')
					this.currentColor = '#F73D72'
				})

			$('#yellow_ann')
				.unbind()
				.bind('click', () => {
					$('#darwing_colors_wrapper span').removeClass('active')
					$('#yellow_ann').addClass('active')
					this.currentColor = '#FDF14C'
				})

			$('#orange_ann')
				.unbind()
				.bind('click', () => {
					$('#darwing_colors_wrapper span').removeClass('active')
					$('#orange_ann').addClass('active')
					this.currentColor = '#FB9348'
				})
		},

		render: function () {
			if (this.ctx === null) return
			console.log('render')

			this.ctx.clearRect(
				0,
				0,
				this.annotation_canvas[0].width,
				this.annotation_canvas[0].height
			)
			this.shapes.forEach(
				({ type, roughElement, points, color, x1, y1, x2, y2, index }) => {
					if (type === 'arrow') {
						this.roughCanvas.path(roughElement, {
							roughness: 0,
							stroke: color,
							strokeWidth: 4,
						})
					} else if (type === 'freehand') {
						this.ctx.beginPath()
						this.ctx.lineWidth = 4
						this.ctx.strokeStyle = color
						this.ctx.lineJoin = 'round'
						this.ctx.lineCap = 'round'
						if (points.length > 0) {
							let _x1 = this.percentage_to_px_horizontal(
								points[0].x2,
								$('#video_wrapper').width()
							)
							let _y1 = this.percentage_to_px_vertical(
								points[0].y2,
								$('#video_wrapper').height()
							)

							this.ctx.moveTo(_x1, _y1)
						}
						for (let i = 1; i < points.length - 2; i++) {
							let _x2 = this.percentage_to_px_horizontal(
								points[i].x2,
								$('#video_wrapper').width()
							)
							let _y2 = this.percentage_to_px_vertical(
								points[i].y2,
								$('#video_wrapper').height()
							)
							let _x2_next = this.percentage_to_px_horizontal(
								points[i + 1].x2,
								$('#video_wrapper').width()
							)
							let _y2_next = this.percentage_to_px_vertical(
								points[i + 1].y2,
								$('#video_wrapper').height()
							)

							const xc = (_x2 + _x2_next) / 2
							const yc = (_y2 + _y2_next) / 2
							this.ctx.quadraticCurveTo(
								this.percentage_to_px_horizontal(
									points[i].x2,
									$('#video_wrapper').width()
								),
								this.percentage_to_px_vertical(
									points[i].y2,
									$('#video_wrapper').height()
								),
								xc,
								yc
							)
						}
						this.ctx.lineTo(
							this.percentage_to_px_vertical(
								points[points.length - 1].x2,
								$('#video_wrapper').width()
							),
							this.percentage_to_px_vertical(
								points[points.length - 1].y2,
								$('#video_wrapper').height()
							)
						)
						this.ctx.stroke()
					} else {
						this.roughCanvas.draw(roughElement)
					}
				}
			)
		},

		append_controls_to_triangle: function () {},

		show_current_annotation_with_time: function (id) {
			// setTimeout(() => {
			this.reset_annotation()
			this.annotation_panel.removeClass('hide')
			$('#annotation_canvas').removeClass('hide')
			const current_annotation_obj = this.previous_annotation.find(
				item => item.comment_id == id
			)
			if (current_annotation_obj && current_annotation_obj.annotation) {
				this.shapes = current_annotation_obj.annotation
				this.initializ_canvas()
				current_annotation_obj.annotation.forEach((item, index) => {
					this.updatedElement(
						index,
						item.x1,
						item.y1,
						item.x2,
						item.y2,
						item.type,
						item.color
					)
				})
			}
			// }, 300)
		},

		// attach_edit_comment_annotation: function() {
		//     this.initializ_canvas();
		//     this.attach_event_listeners_to_canvas();
		// },

		// attach_annotation_edit_controls: function(comment_id) {
		//     this.shapes = [];
		//     this.ctx && this.ctx.clearRect(0, 0, this.annotation_canvas[0].width, this.annotation_canvas[0].height);
		//     $("#annotation_canvas").removeClass('hide').addClass("darwingMode");
		//     if (this.editMode) {
		//         $(".edit_anno_action").removeClass("ann_active");
		//         $(".annotation_panel").remove();
		//         this.editMode = false;
		//     } else {
		//         $(".edit_anno_action").addClass("ann_active");
		//         this.attach_drawing_controls(comment_id);
		//         this.editMode = true;
		//     }
		//     var y = $("#comments_wrapper").scrollTop();  //your current y position on the page
		//     $("#comments_wrapper").scrollTop(y+100);
		// },

		hide_current_annotation_with_time: function () {
			$('#annotation_canvas').addClass('hide')
			$('#resume_the_video').remove()
			this.ctx &&
				this.ctx.clearRect(
					0,
					0,
					this.annotation_canvas[0].width,
					this.annotation_canvas[0].height
				)
			this.shapes = []
			// $('#annotation_panel').remove()
			this.annotation_has_started = false
			$('#annotation_canvas').removeClass('darwingMode')
			$('.player-cta-button').removeClass('hide')
			$('#custom_captions_wrapper').removeClass('hide')
		},

		reset_annotation: function (hide_below_bar) {
			this.ctx &&
				this.ctx.clearRect(
					0,
					0,
					this.annotation_canvas[0].width,
					this.annotation_canvas[0].height
				)
			this.shapes = []
			$('#annotation_canvas').addClass('hide')
			this.handle_annotation.removeClass('ann_active')
			this.currentColor = '#F73D72'
			this.currentTool = 'rectangle'
			if (hide_below_bar && this.annotation_has_started) {
				// $('#annotation_panel').remove()
				playerSettings.media.makePlayableCondition()
			}
		},

		// Attach window resize listener
		attachWindowResizeListener: function () {
			$('#video_wrapper')
				.resize(() => {
					if (!$('#annotation_canvas').hasClass('hide')) {
						$('#annotation_canvas').width($('#player').width())
						$('#annotation_canvas').height($('#player').height())
						$('#annotation_canvas')
							.off('mousemove')
							.off('mousedown')
							.off('mouseup')
						// this.ctx.lineWidth = 10;
						this.attach_event_listeners_to_canvas()
					}
				})
				.resize()
		},
	}

	if (annotationCanvasElement) {
		playerSettings.annotation.initialize()
		playerSettings.annotation.attach_controls()
	}

	const showAnnotationBtn = document.querySelector('#show-annotation')
	showAnnotationBtn.addEventListener('click', () => {
		showAnnotationBtn.classList.toggle('active')
		if (showAnnotationBtn.classList.contains('active')) {
			toggleSiblingElement(showAnnotationBtn, 'svg')
			document.querySelector('#annotation_panel').classList.add('active')
			// annotationCanvasElement.style.display = 'block'
			playerSettings.annotation.initializ_canvas()
			playerSettings.annotation.hide_seekbar_and_timed_comments()
		} else {
			toggleSiblingElement(showAnnotationBtn, 'svg', true)
			document.querySelector('#annotation_panel').classList.remove('active')
			playerSettings.annotation.reset_annotation()
			playerSettings.annotation.show_seekbar_and_timed_comments()
			// annotationCanvasElement.style.display = 'none'
		}
	})

	// HLS init
	const playerSrc = [
		'./20fd0242e93e4fdda762a05a8107cf73/4K-Nature-Film_-_Flow-Of-Life_-30-Minutes-of-Beautiful-Scenery-Relaxing-Music-for-Meditation.m3u8',
		'https://d1ffb1nfch3ckq.cloudfront.net/s095q2%2Ffile%2Fb9b3b32c193e7156d15bdaa2d1929778_f839b6774122ccba2d2b82a1bdc13a48.mp4?response-content-disposition=inline%3Bfilename%3D%22b9b3b32c193e7156d15bdaa2d1929778_f839b6774122ccba2d2b82a1bdc13a48.mp4%22%3B&response-content-type=video%2Fmp4&Expires=1733943645&Signature=EVqiq~KETO974nd288O6-l-soTTJE13EQZ42-mfCpPbJEjxuxdvXoxiBQSc7utUuNCjyXME0E9vx1EzpFyvT2Y78o8xVS46gbo608GAC4NAfUXIJs2jVhnE-N1e~1GhznOlibVO~HNT7poTmIFJilhE7TPrwokhBa9SMv-PRo4SRW9RTbzqK~nLFQaPtffaw8drvwrFeJAM61d52Qf-opuVOKKX5iP4vo9aFF7MXAvpy2J-cbiml658BXZ~LC8KsJ6SYGCdRD-l8cC-9dtnOunkF0tyM7TudLbS4m-B8U1hX4ou2zWQp9-FEofqxy1KAcaPV9YWcS-kIXwli4X-hnA__&Key-Pair-Id=APKAJT5WQLLEOADKLHBQ',
	]
	let activePlayerSrc = 0

	if (
		player.canPlayType('application/vnd.apple.mpegurl') ||
		playerSrc[activePlayerSrc].includes('.mp4')
	) {
		player.src = playerSrc[activePlayerSrc]
	} else if (Hls.isSupported()) {
		var hls = new Hls()
		hls.loadSource(playerSrc[activePlayerSrc])
		hls.attachMedia(player)
	}

	function handleProgress() {
		const buffered = player.buffered
		const chapterSliderItems = document.querySelectorAll('.chapter-slider-item')
		if (buffered.length > 0 && chapterSliderItems) {
			const loaded = buffered.end(buffered.length - 1)

			chapterSliderItems.forEach(item => {
				const progressItem = item.querySelector('.chapter-slider-loading')
				if (
					item.dataset.dataSliderEndTime >= loaded &&
					item.dataset.dataSliderStartTime <= loaded
				) {
					const total = item.dataset.dataSliderEndTime
					const progress = (loaded / total) * 100
					progressItem.style.width = `${progress}%`
				} else if (item.dataset.dataSliderEndTime <= loaded) {
					progressItem.style.width = '100%'
				}
			})
		}
	}
	player.addEventListener('progress', handleProgress)
	player.addEventListener('loadeddata', handleProgress)

	function showHideControls(hide = false) {
		if (!hide) {
			controls.classList.add('active')
		} else {
			controls.classList.remove('active')
		}
	}

	function hideShowControlsOnHover(e) {
		if (!player.paused && e && e.target && e.target !== controls) {
			showHideControls()
			clearTimeout(controlsShowID)
			controlsShowID = setTimeout(() => {
				showHideControls(true)
			}, 4000)
		}
	}
	controls.addEventListener('mousemove', () => {
		showHideControls()
		clearTimeout(controlsShowID)
	})
	player.addEventListener('mousemove', hideShowControlsOnHover)
	playerWrap.addEventListener('mouseleave', () => {
		if (!player.paused) {
			showHideControls(true)
		}
	})

	function playOrPause() {
		const playCircle = document.querySelector('.play-circle')
		let timerId = null

		if (player.paused) {
			player.play()
			toggleSiblingElement(playOrPauseBtn, 'svg')
			toggleSiblingElement(playCircle, 'svg', true)
			playCircle.querySelector('svg').style.animation =
				'playAnim 0.4s ease-in-out'
			timerId = setTimeout(() => {
				playCircle.querySelector('svg').style.animation = ''
			}, 300)
			hideShowControlsOnHover()
		} else {
			player.pause()
			clearTimeout(controlsShowID)
			showHideControls()
			toggleSiblingElement(playOrPauseBtn, 'svg', true)
			toggleSiblingElement(playCircle, 'svg')
			playCircle.querySelector('svg:last-child').style.animation =
				'playAnim 0.4s ease-in-out'
			timerId = setTimeout(() => {
				playCircle.querySelector('svg:last-child').style.animation = ''
			}, 300)
		}
		clearTimeout(timerId)
	}

	function mute() {
		if (!player.muted) {
			player.muted = true
			toggleSiblingElement(muteBtn, 'svg')
			updateProgressVolume(0)
		} else {
			player.muted = false
			toggleSiblingElement(muteBtn, 'svg', true)
			updateProgressVolume(playerVolumeCount)
		}
	}

	function choosePlaybackRate() {
		const playbackRateCount = playbackRate.querySelector('.playback-rate-count')

		switch (playbackRateCount.innerText) {
			case '1':
				playbackRateCount.innerText = 1.25
				player.playbackRate = 1.25
				break
			case '1.25':
				playbackRateCount.innerText = 1.5
				player.playbackRate = 1.25
				break
			case '1.5':
				playbackRateCount.innerText = 1.75
				player.playbackRate = 1.75
				break
			case '1.75':
				playbackRateCount.innerText = 2
				player.playbackRate = 2
				break
			case '2':
				playbackRateCount.innerText = 2.5
				player.playbackRate = 2.5
				break
			case '2.5':
				playbackRateCount.innerText = 0.5
				player.playbackRate = 0.5
				break
			default:
				playbackRateCount.innerText = 1
				player.playbackRate = 1
				break
		}
	}

	playOrPauseBtn.addEventListener('click', playOrPause)
	muteBtn.addEventListener('click', mute)
	playbackRate.addEventListener('click', choosePlaybackRate)
	player.addEventListener('click', playOrPause)
	function hideTextTracks() {
		for (let i = 0; i < player.textTracks.length; i++) {
			player.textTracks[i].mode = 'hidden'
		}
	}
	hideTextTracks()
	player.addEventListener('loadedmetadata', () => {
		setTimeout(() => {
			hideTextTracks()
		}, 10)
		applyPlayerColorTheme({ primary: '#1891ED' })
		duration.innerText = formatTime(player.duration)
		showPlayerOverlayTimer.style.display = 'block'
		showPlayerOverlayTimer.querySelector('span').innerText = formatTime(
			player.duration,
			true
		)
		player.volume = playerVolumeCount

		// Load comments
		playerSettings.comments.loadComments(dataComments)

		// Update active chapter title
		updateActiveChapterTitle()

		// overlay player
		const playerOverlayStart = document.querySelector('.player-overlay-start')

		playerOverlayStart.addEventListener('click', () => {
			commentsContainer.style.display = 'block'
			// Generate CTA button
			generateCTAButton(dataCTA)
			player.play()
			playerOverlayStart.style.display = 'none'
			document
				.querySelector('.player-wrap')
				.classList.add('player-overlay-played')
			toggleSiblingElement(playOrPauseBtn, 'svg')
			showHideControls()
		})

		playerSettings.chapters.loadChapters(dataChapters)
		playerSettings.comments.addComment(
			'17:26 Added a comment using the "addComment" method',
			dataComments
		)
	})

	// const addCommentBtn = document.querySelector('#add-comment')
	// const commentText = document.querySelector('#comment-text')

	// addCommentBtn.addEventListener('click', () => {
	// 	if (commentText.value !== '' && commentText.value.includes(' ')) {
	// 		playerSettings.comments.addComment(commentText.value, dataComments)
	// 		commentText.value = ''
	// 	}
	// })

	// Slider player (time rail)
	const controlsTimeRail = document.getElementById('controls-time-rail')
	const sliderRail = document.getElementById('controls-time-rail')
	const sliderThumb = document.getElementById('slider-thumb')
	const activeChapterTitle = document.querySelector(
		'.controls-active-chapter-title'
	)
	let isDragging = false
	let isDraggingType = 'time'
	let activeChapter = 1

	function chooseActiveChapter() {
		dataChapters.chapters.forEach((item, idx) => {
			const start = item.M.line.S
			const end = dataChapters.chapters[idx + 1]
				? dataChapters.chapters[idx + 1].M.line.S
				: player.duration
			if (player.currentTime >= start && player.currentTime <= end) {
				activeChapter = idx + 1
			}
		})
	}

	function updateSlider() {
		const startValue = dataChapters.chapters[activeChapter - 1].M.line.S
		const endValue = dataChapters.chapters[activeChapter]
			? dataChapters.chapters[activeChapter].M.line.S
			: player.duration
		const progressRailPercent =
			((player.currentTime - startValue) / (endValue - startValue)) * 100
		const progressThumbPercent = (player.currentTime / player.duration) * 100

		const sliderRailItemsProgress = sliderRail.querySelectorAll(
			'.chapter-slider-progress'
		)

		sliderRailItemsProgress.forEach((item, idx) => {
			if (idx < activeChapter - 1) {
				item.style.width = '100%'
			} else {
				item.style.width = 0
			}
		})

		sliderThumb.style.left = progressThumbPercent + '%'

		if (progressRailPercent <= 99.99) {
			sliderRailItemsProgress[activeChapter - 1].style.width =
				progressRailPercent + '%'
		} else {
			sliderRailItemsProgress[activeChapter - 1].style.width = '100%'
			++activeChapter
		}
		currentTime.innerHTML = formatTime(player.currentTime)
	}

	function updateActiveChapterTitle() {
		activeChapterTitle.querySelector('span').innerText =
			dataChapters.chapters[activeChapter - 1].M.name.S
	}

	function moveSlider(event, elem) {
		const rect = elem.getBoundingClientRect()
		if (rect.width > 0) {
			const offsetX = event.clientX - rect.left
			const width = rect.width
			const percentage = offsetX / width

			if (isDraggingType === 'time' && percentage >= 0 && percentage <= 0.99) {
				const newTime = player.duration * percentage
				player.currentTime = newTime
				chooseActiveChapter()
				updateSlider()
			}
			if (isDraggingType === 'volume' && percentage >= 0 && percentage <= 1) {
				if (percentage === 0) {
					toggleSiblingElement(muteBtn, 'svg')
				} else {
					toggleSiblingElement(muteBtn, 'svg', true)
				}
				playerVolumeCount = percentage
				player.volume = percentage
				updateProgressVolume(percentage)
			}
		}
	}

	controlsTimeRail.addEventListener('mousedown', event => {
		isDragging = true
		isDraggingType = 'time'
		moveSlider(event, controlsTimeRail, isDraggingType)
	})

	player.addEventListener('timeupdate', () => {
		currentTime.innerText = formatTime(player.currentTime)
		checkIsCommentActive(player.currentTime)
		updateSlider()
		updateActiveChapterTitle()
	})

	// Volume slider

	const volumeSlider = document.getElementById('volume-slider')

	function updateProgressVolume(percentage) {
		const progressPercent = percentage * 100
		volumeSlider.querySelector('.volume-slider-progress').style.width =
			progressPercent + '%'
	}

	volumeSlider.addEventListener('mousedown', event => {
		isDragging = true
		isDraggingType = 'volume'
		moveSlider(event, volumeSlider, isDraggingType)
	})

	window.addEventListener('mousemove', event => {
		if (isDragging && isDraggingType === 'time') {
			moveSlider(event, controlsTimeRail)
		} else if (isDragging && isDraggingType === 'volume') {
			moveSlider(event, volumeSlider)
		}
	})
	window.addEventListener('mouseup', () => {
		isDragging = false
	})

	// When the video ends
	const playerOverlayEnd = document.querySelector('.player-overlay-end')
	const playerOverlayBtnEnd = document.querySelector(
		'.player-overlay-button-end'
	)

	player.addEventListener('ended', () => {
		const playerCtaButtonDefault = document.querySelector(
			'.player-cta-button-default'
		)
		showHideControls(true)
		commentsContainer.style.display = 'none'
		playerOverlayEnd.style.display = 'flex'
		playerCtaButtonDefault.classList.add('hidden')
		toggleSiblingElement(playOrPauseBtn, 'svg', true)
		activeChapter = 1
	})

	playerOverlayBtnEnd.addEventListener('click', () => {
		const playerCtaButtonDefault = document.querySelector(
			'.player-cta-button-default'
		)
		commentsContainer.style.display = 'block'
		player.currentTime = 0
		player.play()
		playerOverlayEnd.style.display = 'none'
		playerCtaButtonDefault.classList.remove('hidden')
		toggleSiblingElement(playOrPauseBtn, 'svg')
	})

	// Theatre mode
	const theatreBtn = document.getElementById('theatre-mode')
	theatreBtn.addEventListener('click', () => {
		playerWrap.classList.toggle('theatre-mode-wrap')
		if (playerWrap.classList.contains('theatre-mode-wrap')) {
			toggleSiblingElement(theatreBtn, 'svg')
		} else {
			toggleSiblingElement(theatreBtn, 'svg', true)
		}
	})

	// Fullscreen
	const fullScreenBtn = document.getElementById('fullscreen')

	fullScreenBtn.addEventListener('click', toggleFullScreen)

	function toggleFullScreen() {
		if (!document.fullscreenElement) {
			if (playerWrap.requestFullscreen) {
				playerWrap.requestFullscreen()
			} else if (playerWrap.webkitRequestFullscreen) {
				playerWrap.webkitRequestFullscreen()
			} else if (playerWrap.msRequestFullscreen) {
				playerWrap.msRequestFullscreen()
			}
		} else {
			if (document.exitFullscreen) {
				document.exitFullscreen()
			} else if (document.webkitExitFullscreen) {
				document.webkitExitFullscreen()
			} else if (document.msExitFullscreen) {
			}
		}
	}

	const toggleFullscreenStyles = e => {
		e.preventDefault()

		const isFullscreen = !!document.fullscreenElement
		if (isFullscreen) {
			setTimeout(() => {
				document.querySelector('.controls').style.position = 'fixed'
			}, 0)
		} else {
			document.querySelector('.controls').style.position = 'absolute'
		}
	}

	document.addEventListener('fullscreenchange', toggleFullscreenStyles)
	document.addEventListener('webkitfullscreenchange', toggleFullscreenStyles)
	document.addEventListener('mozfullscreenchange', toggleFullscreenStyles)

	// Keyboard
	document.addEventListener('keydown', e => {
		const skipAmount = 10
		if (player.currentTime > 0) {
			if (e.code === 'Space') {
				e.preventDefault()
				if (player.paused || player.ended) {
					player.play()
					toggleSiblingElement(playOrPauseBtn, 'svg')
				} else {
					player.pause()
					toggleSiblingElement(playOrPauseBtn, 'svg', true)
				}
			}
			if (e.code === 'ArrowLeft') {
				player.currentTime -= skipAmount
				chooseActiveChapter()
				updateSlider()
			}
			if (e.code === 'ArrowRight') {
				player.currentTime += skipAmount
				chooseActiveChapter()
				updateSlider()
			}
			if (e.code === 'KeyK') {
				toggleFullScreen()
			}
		}
	})

	//  On loading
	const loadingBgSpinner = document.querySelector('.loading-bg-img')
	player.addEventListener('waiting', () => {
		loadingBgSpinner.style.display = 'block'
	})
	player.addEventListener('canplay', () => {
		loadingBgSpinner.style.display = 'none'
	})
	player.addEventListener('playing', () => {
		loadingBgSpinner.style.display = 'none'
	})

	// Captions
	const captionTrack = document.getElementById('captions-track')
	const captionBtn = document.getElementById('captions-btn')
	const customCaptions = document.querySelector('.custom-captions')
	let isShowCaptions = false
	let activeCuesLength = 0
	customCaptions.style.display = 'none'

	captionBtn.addEventListener('click', () => {
		if (isShowCaptions) {
			isShowCaptions = false
			customCaptions.style.display = 'none'
			toggleSiblingElement(captionBtn, 'svg', true)
		} else {
			if (activeCuesLength > 0) {
				customCaptions.style.display = 'block'
			} else {
				customCaptions.style.display = 'none'
			}
			isShowCaptions = true
			toggleSiblingElement(captionBtn, 'svg')
		}
	})

	function showCaptions(text) {
		if (text) {
			customCaptions.innerText = text
		}
		customCaptions.style.display = 'block'
	}

	function hideCaptions(text) {
		if (text) {
			customCaptions.innerText = text
		}
		customCaptions.style.display = 'none'
	}

	captionTrack.addEventListener('cuechange', () => {
		const activeCues = player.textTracks[0].activeCues

		activeCuesLength = activeCues.length

		if (isShowCaptions && activeCues.length > 0) {
			showCaptions(activeCues[0].text)
		} else {
			hideCaptions(activeCues.length > 0 && activeCues[0].text)
		}
	})

	function loadChapters(dataChapters) {
		if (!dataChapters?.chapters?.length) return

		const chaptersMenu = document.querySelector('.video_chapters')
		const chapterSliderItems = document.querySelector('.chapter-slider-items')

		const createChapterButton = (chapter, chapterStart, chapterEnd) => {
			return `<li>
				<a href="javascript:;" 
				   data-chapterstamp="${chapterStart}"
				   data-chapterstampend="${chapterEnd}"
				>${formatTime(chapterStart)}</a
				>${chapter.M.name.S}
			</li>`
		}

		const createSliderItem = (chapter, chapterStart, chapterEnd) => {
			const width = ((chapterEnd - chapterStart) / player.duration) * 100
			const item = document.createElement('span')
			item.classList.add('chapter-slider-item')
			item.dataset.dataSliderStartTime = chapterStart
			item.dataset.dataSliderEndTime = chapterEnd
			item.style.width = `${width}%`

			const elements = [
				['chapter-slider-title', chapter.M.name.S],
				['chapter-slider-loading', ''],
				['chapter-slider-progress', ''],
				['chapter-slider-bg', ''],
			].map(([className, text]) => {
				const el = document.createElement('span')
				el.classList.add(className)
				if (className === 'chapter-slider-progress') {
					el.style.backgroundColor = playerSettings.themeColor.primary
				}
				if (className === 'chapter-slider-bg') {
					el.style.backgroundColor = playerSettings.themeColor.secondary
				}
				if (text) el.textContent = text
				return el
			})

			elements.forEach(el => item.appendChild(el))
			return { item, titleElement: elements[0] }
		}

		chaptersMenu.addEventListener('click', e => {
			if (e.target.tagName === 'A') {
				player.currentTime = Number(e.target.dataset.chapterstamp)
				chooseActiveChapter()
			}
		})

		dataChapters.chapters.forEach((chapter, i) => {
			const chapterStart = chapter.M.line.S
			const chapterEnd =
				dataChapters.chapters[i + 1]?.M.line.S ?? player.duration

			chaptersMenu.innerHTML += createChapterButton(
				chapter,
				chapterStart,
				chapterEnd
			)

			const { item, titleElement } = createSliderItem(
				chapter,
				chapterStart,
				chapterEnd
			)
			chapterSliderItems.appendChild(item)

			requestAnimationFrame(() => {
				const rect = titleElement.getBoundingClientRect()
				const playerPos = player.getBoundingClientRect()
				const relativePosition = {
					top: rect.top - playerPos.top,
					left: rect.left - playerPos.left,
				}

				if (rect.width + relativePosition.left > playerPos.width) {
					titleElement.style.left = 'auto'
					titleElement.style.right =
						i === dataChapters.chapters.length - 1 ? '10px' : '0'
				}
			})
		})
	}

	// Comments
	function loadComments(dataComments) {
		if (!dataComments?.comments?.length) return

		dataComments.comments.forEach(comment => {
			commentsContainer.innerHTML += createComment(comment)
		})

		commentsContainer.addEventListener('click', e => {
			if (e.target.closest('.controls-comments-item')) {
				player.currentTime = Number(
					e.target.closest('.controls-comments-item').dataset.timestamp
				)
				chooseActiveChapter()
				updateSlider()
			}
		})
	}

	const createComment = comment => {
		const left = (comment.media_timestamp / player.duration) * 100

		return `<div class="controls-comments-item" style="left: ${left}%" data-timestamp="${comment.media_timestamp}" data-id="${comment.id}">
						<div class='controls-comments-avatar'>
							<span>${comment.user.first_name.charAt(0)}</span>
							<!-- <img src="" /> -->
						</div>
						<div class='controls-comments-info'>
							<div class='controls-comments-info-text'>
								<h5>
									${comment.user.first_name + ' ' + comment.user.last_name}
									<span>${comment.comment_time}</span>
								</h5>
								<p>${comment.comment}</p>
								${comment.replies_count > 0 ? `<span class='controls-comments-info-reply'>${comment.replies_count}+ other comment</span>` : ''}
							</div>
							<svg width="8" height="14" viewBox="0 0 8 14" fill="none" xmlns="http://www.w3.org/2000/svg">
								<path d="M1 13L7 7L1 1" stroke="#f1f1f1" stroke-width="1.5" stroke-linejoin="round"></path>
							</svg>
						</div>
					</div>`
	}

	function addComment(dataCommentStr, dataComments) {
		function parseTimeAndComment(input) {
			const [timeStr, ...commentParts] = input.split(' ')
			const comment = commentParts.join(' ')
			const timeParts = timeStr.split(':')

			let totalSeconds = 0

			if (timeParts.length === 3) {
				const [hours, minutes, seconds] = timeParts
				totalSeconds = +hours * 3600 + +minutes * 60 + +seconds
			} else if (timeParts.length === 2) {
				const [minutes, seconds] = timeParts
				totalSeconds = +minutes * 60 + +seconds
			}
			return {
				seconds: totalSeconds,
				comment,
			}
		}

		const { seconds, comment } = parseTimeAndComment(dataCommentStr)

		const dataComment = {
			id: '29121241421',
			user: {
				first_name: dataComments.comments[0].user.first_name,
				last_name: dataComments.comments[0].user.last_name,
			},
			media_timestamp: seconds,
			comment_time: getCurrentDateFormatted(new Date()),
			comment: comment,
			replies_count: 0,
		}
		commentsContainer.innerHTML += createComment(dataComment)
	}

	function deleteComment(commentId) {
		const commentItem = document.querySelector(
			`.controls-comments-item[data-id="${commentId}"]`
		)
		commentItem.remove()
	}

	function checkIsCommentActive(currentTime) {
		const commentsItems = document.querySelectorAll('.controls-comments-item')
		const COMMENT_DURATION = 5

		const sortedComments = Array.from(commentsItems).sort((a, b) => {
			return parseFloat(a.dataset.timestamp) - parseFloat(b.dataset.timestamp)
		})

		sortedComments.forEach((item, index) => {
			const commentTimestamp = parseFloat(item.dataset.timestamp)
			const nextComment = sortedComments[index + 1]
			const nextCommentTimestamp = nextComment
				? parseFloat(nextComment.dataset.timestamp)
				: Infinity
			const commentEndTime = commentTimestamp + COMMENT_DURATION

			if (currentTime < commentTimestamp) {
				item.classList.remove('active')
			} else if (currentTime >= commentTimestamp) {
				if (
					currentTime < nextCommentTimestamp &&
					currentTime <= commentEndTime
				) {
					item.classList.add('active')
				} else {
					item.classList.remove('active')
				}
			}
		})
	}

	// Generate СTA Button
	const generateCTAButton = dataCTA => {
		const ctaButton = document.createElement('a')
		ctaButton.href = dataCTA.link
		ctaButton.className = `player-cta-button-default player-cta-button ${dataCTA.cta_position}`
		ctaButton.style.backgroundColor = dataCTA.btn_color
		ctaButton.style.color = dataCTA.txt_color
		ctaButton.textContent = dataCTA.title

		playerWrap.appendChild(ctaButton)

		const ctaButtonClone = ctaButton.cloneNode(true)
		ctaButtonClone.classList.add('centered')
		ctaButtonClone.classList.remove('player-cta-button-default')
		playerOverlayEnd.appendChild(ctaButtonClone)
	}

	function applyPlayerColorTheme({
		primary = playerSettings.themeColor.primary,
		secondary = playerSettings.themeColor.secondary,
	}) {
		playerSettings.themeColor.primary = primary
		playerSettings.themeColor.secondary = secondary
		sliderThumb.style.backgroundColor = primary
		document.querySelector('.player-overlay-button svg path').style.fill =
			primary
		document.documentElement.style.setProperty('--pulse-color', primary)
	}

	// Errors
	player.addEventListener('error', () => {
		console.error('Video Error:', e)
		// loadingBgSpinner.style.display = 'none'
	})

	// ARIA attributes for control buttons
	playOrPauseBtn.setAttribute('aria-label', 'Play/Pause')
	muteBtn.setAttribute('aria-label', 'Mute')
	fullScreenBtn.setAttribute('aria-label', 'Fullscreen')

	// Helper functions
	function getCurrentDateFormatted(date) {
		const monthNames = [
			'Jan',
			'Feb',
			'Mar',
			'Apr',
			'May',
			'Jun',
			'Jul',
			'Aug',
			'Sep',
			'Oct',
			'Nov',
			'Dec',
		]
		const day = date.getDate()
		const month = monthNames[date.getMonth()]
		return `${month} ${day}`
	}

	function formatTime(seconds, named = false) {
		const minutes = Math.floor(seconds / 60)
		const sec = Math.floor(seconds % 60)
		if (!named) {
			return (
				(minutes < 10 ? '0' : '') + minutes + ':' + (sec < 10 ? '0' : '') + sec
			)
		} else {
			return (
				(minutes < 10 && minutes > 0 ? '0' : '') +
				(minutes > 0 ? minutes : '') +
				(minutes > 0 ? ' min ' : '') +
				(sec < 10 ? '0' : '') +
				(sec + ' sec')
			)
		}
	}

	function toggleSiblingElement(parentElement, element, showFirst = false) {
		if (showFirst) {
			parentElement.querySelector(`${element}:first-child`).style.display =
				'block'
			parentElement.querySelector(`${element}:last-child`).style.display =
				'none'
		} else {
			parentElement.querySelector(`${element}:first-child`).style.display =
				'none'
			parentElement.querySelector(`${element}:last-child`).style.display =
				'block'
		}
	}
})
